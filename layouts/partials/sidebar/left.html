<aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="{{ T " toggleMenu" }}">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        {{/*
        Robust Avatar Check:
        If avatar is a boolean true, treat it as enabled but using default.
        If it's an object, use its properties.
        */}}
        {{- $avatar := .Site.Params.sidebar.avatar -}}
        {{- $avatarEnabled := false -}}
        {{- if reflect.IsMap $avatar -}}
        {{- $avatarEnabled = default true $avatar.enabled -}}
        {{- else if $avatar -}}
        {{- $avatarEnabled = true -}}
        {{- end -}}

        {{ if $avatarEnabled }}
        <figure class="site-avatar">
            {{- $src := "/img/avatar.png" -}}
            {{- $isLocal := true -}}
            {{- if reflect.IsMap $avatar -}}
            {{- if $avatar.src }}{{ $src = $avatar.src }}{{ end -}}
            {{- if isset $avatar "local" }}{{ $isLocal = $avatar.local }}{{ end -}}
            {{- end -}}

            {{/* 使用 absURL 确保在子路径部署时图片路径绝对正确 */}}
            {{- $avatarPath := trim $src "/" -}}

            <a href="javascript:void(0)" class="avatar-link" data-avatar="{{ $avatarPath | absURL }}">
                <img src="{{ $avatarPath | absURL }}" width="300" height="300" class="site-logo" loading="lazy"
                    alt="Avatar">
            </a>

            {{ with $.Site.Params.sidebar.emoji }}
            <span class="emoji">{{ . }}</span>
            {{ end }}
        </figure>
        {{ end }}

        <div class="site-meta">
            <h1 class="site-name"><a href="{{ .Site.BaseURL | relLangURL }}">{{ .Site.Title }}</a></h1>
            <h2 class="site-description">{{ .Site.Params.sidebar.subtitle }}</h2>
        </div>
    </header>

    {{- with .Site.Menus.social -}}
    <ol class="menu-social">
        {{ range . }}
        <li>
            <a href='{{ .URL }}' {{ if eq (default true .Params.newTab) true }}target="_blank" {{ end }} {{ with .Name
                }}title="{{ . }}" {{ end }} rel="me">
                {{ $icon := default "link" .Params.Icon }}
                {{ with $icon }}
                {{ partial "helper/icon" . }}
                {{ end }}
            </a>
        </li>
        {{ end }}
    </ol>
    {{- end -}}

    <ol class="menu" id="main-menu">
        {{ $currentPage := . }}
        {{ range .Site.Menus.main }}
        {{ $active := or (eq $currentPage.RelPermalink .URL) (or ($currentPage.HasMenuCurrent "main" .)
        ($currentPage.IsMenuCurrent "main" .)) }}
        <li {{ if $active }} class='current' {{ end }}>
            {{/* Use relLangURL to ensure links stay in current language */}}
            <a href='{{ .URL | relLangURL }}' {{ if eq .Params.newTab true }}target="_blank" {{ end }}>
                {{ $icon := default .Pre .Params.Icon }}
                {{ with $icon }}
                {{ partial "helper/icon" . }}
                {{ end }}
                <span>{{- .Name -}}</span>
            </a>
        </li>
        {{ end }}
    </ol>

    <div class="sidebar-bottom-controls">
        {{- $currentLanguageCode := .Language.Lang -}}
        {{ if ( compare.Gt .Site.Home.AllTranslations.Len 1 ) }}
        <div id="lang-switch">
            {{ partial "helper/icon" "language" }}
            {{ range .Site.Home.AllTranslations }}
            {{ if ne .Language.Lang $currentLanguageCode }}
            <a href="{{ .Permalink }}" class="lang-link">
                {{ T "selectLanguage" }}
            </a>
            {{ end }}
            {{ end }}
        </div>
        {{ end }}

        {{ if (default false .Site.Params.colorScheme.toggle) }}
        <div id="dark-mode-toggle">
            {{ partial "helper/icon" "toggle-left" }}
            {{ partial "helper/icon" "toggle-right" }}
            <span>{{ T "darkMode" }}</span>
        </div>
        {{ end }}

        {{/* Fixed Copyright below toggles */}}
        <div class="sidebar-copyright">
            &copy; {{ now.Format "2006" }} {{ default .Site.Title .Site.Copyright }}
        </div>
    </div>
</aside>

<!-- 头像弹出层 -->
<div id="avatar-modal" class="avatar-modal">
    <div class="avatar-modal-overlay"></div>
    <div class="avatar-modal-content">
        <img src="" alt="Avatar" class="avatar-modal-img">
    </div>
</div>

<script>
    (function () {
        const avatarLink = document.querySelector('.avatar-link');
        const modal = document.getElementById('avatar-modal');
        const modalImg = modal.querySelector('.avatar-modal-img');
        const overlay = modal.querySelector('.avatar-modal-overlay');

        if (avatarLink && modal) {
            avatarLink.addEventListener('click', function (e) {
                e.preventDefault();
                const avatarSrc = this.getAttribute('data-avatar');
                modalImg.src = avatarSrc;
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });

            function closeModal() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            overlay.addEventListener('click', closeModal);
            modal.querySelector('.avatar-modal-content').addEventListener('click', closeModal);

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeModal();
                }
            });
        }
    })();
</script>